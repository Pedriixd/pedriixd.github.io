<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STICKEAME - Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-inactive { opacity: 0; pointer-events: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        #logo-container { display: flex; align-items: center; height: 40px; }
    </style>
</head>
<body class="bg-slate-100 text-gray-900 flex flex-col h-screen">

    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 modal-inactive">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-buttons" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <header class="flex items-center justify-between bg-white text-slate-800 px-4 py-3 border-b border-slate-200 z-20">
        <div class="flex items-center space-x-4">
            <button id="toggle-gallery-btn" class="md:hidden flex items-center gap-2 bg-slate-100 text-slate-600 font-semibold px-3 py-2 rounded-lg shadow-sm hover:bg-slate-200 transition">
                <i class="fa-solid fa-images"></i>
            </button>
            <div id="logo-container">
                <img src="logo.png" alt="STICKEAME Logo" class="h-10 w-auto rounded-full" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='inline';">
                <span id="logo-fallback" class="font-bold text-xl tracking-wider select-none" style="display:none;">STICKEAME</span>
            </div>
        </div>
        <nav class="flex items-center space-x-3">
            <a href="https://www.instagram.com/pedriixd.alvez" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="p-2 text-slate-500 hover:text-emerald-600 transition-colors duration-300">
                <i class="fa-brands fa-instagram fa-xl"></i>
            </a>
        </nav>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside id="gallery-panel" class="w-full md:w-72 lg:w-96 bg-white shadow-lg p-4 flex-col gap-4 absolute md:relative z-10 md:z-0 h-full md:flex -translate-x-full md:translate-x-0 transition-transform duration-300">
             <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold">Galería de Stickers</h2>
                <button id="close-gallery-btn" class="md:hidden p-2 rounded-full hover:bg-slate-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex flex-col gap-3 mb-3">
                <input id="search-input" type="text" placeholder="Buscar por nombre..." class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400">
                <div id="category-filters" class="flex flex-wrap gap-2"></div>
                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600"><input id="favorites-toggle" type="checkbox" class="h-5 w-5 text-emerald-500 rounded border-slate-300 focus:ring-emerald-400"/> <span>Mostrar solo favoritos</span></label>
            </div>
            <div id="stickers-container" class="flex-1 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-3 pr-2 scrollbar-hide">
            </div>
        </aside>

        <main class="flex-1 flex flex-col p-2 md:p-4 bg-slate-200">
            <div class="flex-1 flex items-stretch bg-white rounded-lg shadow-inner overflow-hidden relative">
                <div id="canvas-container" class="flex-1 flex items-center justify-center p-2">
                    <canvas id="canvas" class="shadow-lg rounded-md"></canvas>
                </div>
                <div id="text-panel" class="hidden absolute right-0 top-0 h-full flex-shrink-0 w-64 p-4 border-l bg-white/90 backdrop-blur-sm rounded-r-lg shadow-lg overflow-y-auto">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Editar Texto</h2>
                        <button id="close-panel" class="p-1 rounded-full text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="fontBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100 w-full"><i class="fa-solid fa-font mr-2"></i>Fuentes</button>
                        <div id="font-options" class="hidden flex flex-col space-y-1 p-2 bg-slate-100 rounded-md">
                            <button class="font-option text-left p-1 rounded hover:bg-slate-200" data-font="Inter">Inter</button>
                            <button class="font-option text-left p-1 rounded hover:bg-slate-200" data-font="Arial">Arial</button>
                             <button class="font-option text-left p-1 rounded hover:bg-slate-200" data-font="Times New Roman">Times New Roman</button>
                            <button class="font-option text-left p-1 rounded hover:bg-slate-200" data-font="Comic Neue">Comic Neue</button>
                        </div>
                        <button id="colorBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100 w-full"><i class="fa-solid fa-palette mr-2"></i>Colores</button>
                        <div id="color-options" class="hidden grid grid-cols-5 gap-2 p-2 bg-slate-100 rounded-md">
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm border" style="background-color: #000000;" data-color="#000000"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm border" style="background-color: #FFFFFF;" data-color="#FFFFFF"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm" style="background-color: #ef4444;" data-color="#ef4444"></div>
                        </div>
                        <button id="boldBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100 w-full"><i class="fa-solid fa-bold mr-2"></i>Negrita</button>
                        <button id="italicBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100 w-full"><i class="fa-solid fa-italic mr-2"></i>Cursiva</button>
                        <button id="underlineBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100 w-full"><i class="fa-solid fa-underline mr-2"></i>Subrayado</button>
                    </div>
                </div>
                <div id="layer-panel" class="hidden absolute right-0 top-0 h-full flex-shrink-0 w-64 p-4 border-l bg-white/90 backdrop-blur-sm rounded-r-lg shadow-lg">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Capas</h2>
                        <button id="close-layer-panel" class="p-1 rounded-full text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="bringForwardBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100"><i class="fa-solid fa-arrow-up mr-2"></i>Adelante</button>
                        <button id="sendBackwardBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-lg shadow-sm border hover:bg-slate-100"><i class="fa-solid fa-arrow-down mr-2"></i>Atrás</button>
                    </div>
                </div>
            </div>

            <footer class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 bg-white p-3 rounded-t-lg border-t border-slate-200 shadow-lg mt-2">
                <button id="exportPdfBtn" class="flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-600 px-3 py-2 rounded-lg transition shadow-sm font-semibold text-white col-span-2 md:col-span-1">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>Descargar y Enviar</span>
                </button>
                <label for="upload-images" class="flex items-center justify-center gap-2 cursor-pointer bg-slate-200 hover:bg-slate-300 px-3 py-2 rounded-lg transition select-none shadow-sm font-medium text-slate-700">
                    <i class="fa-solid fa-image"></i>
                    <span>Subir Imagen</span>
                    <input id="upload-images" type="file" accept="image/jpeg,image/png,image/webp" multiple class="hidden">
                </label>
                <button id="addTextBtn" class="flex items-center justify-center gap-2 bg-slate-200 hover:bg-slate-300 px-3 py-2 rounded-lg transition shadow-sm font-medium text-slate-700">
                    <i class="fa-solid fa-font"></i>
                    <span>Añadir Texto</span>
                </button>
                <button id="deleteSelectionBtn" class="flex items-center justify-center gap-2 bg-rose-100 text-rose-600 hover:bg-rose-200 px-3 py-2 rounded-lg transition shadow-sm font-medium">
                    <i class="fa-solid fa-times"></i>
                    <span>Eliminar</span>
                </button>
                <div class="col-span-2 lg:col-span-1 flex items-center justify-center gap-2 bg-slate-100 p-2 rounded-lg border">
                    <button id="prev-page-btn" class="px-2 py-1 rounded-md hover:bg-slate-200 disabled:opacity-40" disabled><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="page-indicator" class="font-semibold text-sm text-slate-600">Pág 1 / 1</span>
                    <button id="next-page-btn" class="px-2 py-1 rounded-md hover:bg-slate-200 disabled:opacity-40" disabled><i class="fa-solid fa-chevron-right"></i></button>
                    <button id="add-page-btn" class="px-2 py-1 rounded-md bg-emerald-500 text-white hover:bg-emerald-600"><i class="fa-solid fa-plus"></i></button>
                </div>
                <button id="reset-app-btn" class="flex items-center justify-center gap-2 bg-amber-100 text-amber-700 hover:bg-amber-200 px-3 py-2 rounded-lg transition shadow-sm font-medium">
                    <i class="fa-solid fa-arrows-rotate"></i>
                    <span>Resetear</span>
                </button>
            </footer>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STICKERS_JSON_PATH = "stickers.json";
            const A4_ASPECT_RATIO = 210 / 297;
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const DPI = 300;
            const EXPORT_WIDTH_PX = Math.round((A4_WIDTH_MM * DPI) / 25.4);
            const EXPORT_HEIGHT_PX = Math.round((A4_HEIGHT_MM * DPI) / 25.4);

            let canvas, pages = [], currentPageIndex = 0, allStickers = [], favorites = {};

            const init = async () => {
                canvas = new fabric.Canvas('canvas', { backgroundColor: '#FFFFFF', preserveObjectStacking: true });
                loadState();
                await fetchData();
                addEventListeners();
                renderCurrentPage();
                resizeCanvas();
                updatePaginator();
            };

            const saveState = () => {
                try {
                    const state = {
                        pages: pages.map(p => ({ id: p.id, objects: p.canvas ? p.canvas.toJSON(['objects']).objects : p.objects })),
                        currentPageIndex,
                        favorites
                    };
                    localStorage.setItem('stickeameState', JSON.stringify(state));
                } catch (error) { console.error("Error al guardar:", error); }
            };
            
            const loadState = () => {
                const savedState = localStorage.getItem('stickeameState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    pages = state.pages.map(p => ({ id: p.id, canvas: null, objects: p.objects }));
                    currentPageIndex = state.currentPageIndex || 0;
                    favorites = state.favorites || {};
                }
                if (pages.length === 0) {
                    pages.push({ id: crypto.randomUUID(), canvas: null, objects: [] });
                }
            };

            const fetchData = async () => {
                document.getElementById('stickers-container').innerHTML = '<p>Cargando...</p>';
                try {
                    const response = await fetch(STICKERS_JSON_PATH);
                    if (!response.ok) throw new Error("No se encontró el archivo stickers.json");
                    allStickers = await response.json();
                    renderGallery();
                } catch (error) {
                    document.getElementById('stickers-container').innerHTML = `<p class="col-span-full text-center text-red-500"><b>Error:</b> Asegúrate de que el archivo <b>stickers.json</b> está en la misma carpeta que este HTML.</p>`;
                }
            };

            const renderGallery = () => {
                const stickersContainer = document.getElementById('stickers-container');
                const categoryFiltersContainer = document.getElementById('category-filters');
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const showFavorites = document.getElementById('favorites-toggle').checked;
                const activeCategory = document.querySelector('.category-btn.bg-emerald-500')?.dataset.category || 'Todos';

                const filtered = allStickers.filter(s => 
                    (s.nombre?.toLowerCase() || '').includes(searchTerm) && 
                    (!showFavorites || favorites[s.url]) &&
                    (activeCategory === 'Todos' || s.categoria === activeCategory)
                );

                stickersContainer.innerHTML = filtered.length === 0 ? '<p class="col-span-full text-center text-slate-500 mt-4">No se encontraron stickers.</p>' : '';
                filtered.forEach(sticker => {
                    const isFav = favorites[sticker.url];
                    const card = document.createElement('div');
                    card.className = 'bg-slate-50 rounded-lg shadow-sm p-2 flex flex-col items-center gap-2 cursor-pointer relative hover:shadow-md hover:-translate-y-1 transition-all';
                    card.innerHTML = `<img src="${sticker.url}" alt="${sticker.nombre}" class="w-full h-20 object-contain" loading="lazy"><p class="text-xs font-semibold text-center text-slate-700">${sticker.nombre}</p><button data-url="${sticker.url}" class="favorite-btn absolute top-1 right-1 p-1 rounded-full"><i class="fa-${isFav ? 'solid text-red-500' : 'regular text-slate-300'} fa-heart"></i></button>`;
                    card.querySelector('img').addEventListener('click', () => addImageToCanvas(sticker.url));
                    stickersContainer.appendChild(card);
                });

                if (categoryFiltersContainer.children.length === 0 && allStickers.length > 0) {
                    const categories = ['Todos', ...new Set(allStickers.map(s => s.categoria).filter(Boolean))];
                    categoryFiltersContainer.innerHTML = '';
                    categories.forEach(cat => {
                        const btn = document.createElement('button');
                        btn.className = `category-btn px-3 py-1 text-sm rounded-full font-medium ${cat === 'Todos' ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`;
                        btn.textContent = cat;
                        btn.dataset.category = cat;
                        categoryFiltersContainer.appendChild(btn);
                    });
                }
            };
            
            const resizeCanvas = () => {
                const container = document.getElementById('canvas-container');
                const { clientWidth: cw, clientHeight: ch } = container;
                let newWidth, newHeight;
                if ((cw / ch) > A4_ASPECT_RATIO) { newHeight = ch - 20; newWidth = newHeight * A4_ASPECT_RATIO; } 
                else { newWidth = cw - 20; newHeight = newWidth / A4_ASPECT_RATIO; }
                canvas.setDimensions({ width: newWidth, height: newHeight });
            };
            
            const updatePaginator = () => {
                document.getElementById('page-indicator').textContent = `Pág ${currentPageIndex + 1} / ${pages.length}`;
                document.getElementById('prev-page-btn').disabled = currentPageIndex === 0;
                document.getElementById('next-page-btn').disabled = currentPageIndex >= pages.length - 1;
            };

            const renderCurrentPage = () => {
                const page = pages[currentPageIndex];
                canvas.loadFromJSON({ objects: page.objects || [] }, () => {
                    canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
                });
                pages[currentPageIndex].canvas = canvas;
                updatePaginator();
            };
            
            const syncAndSave = () => {
                if (pages[currentPageIndex]) {
                    pages[currentPageIndex].objects = canvas.toJSON().objects;
                    saveState();
                }
            };

            const addImageToCanvas = (url) => {
                const proxyUrl = `https://images1-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&refresh=2592000&url=${encodeURIComponent(url)}`;
                fabric.Image.fromURL(proxyUrl, (img) => {
                    img.scaleToWidth(canvas.getWidth() * 0.5);
                    img.set({ left: canvas.getWidth() / 2, top: canvas.getHeight() / 2, originX: 'center', originY: 'center' });
                    canvas.add(img);
                }, { crossOrigin: 'anonymous' });
            };

            function addEventListeners() {
                window.showModal = (message, buttonsHtml = '<button onclick="hideModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600">Cerrar</button>') => {
                    document.getElementById('modal-message').innerHTML = message;
                    document.getElementById('modal-buttons').innerHTML = buttonsHtml;
                    document.getElementById('message-modal').classList.replace('modal-inactive', 'modal-active');
                };
                window.hideModal = () => document.getElementById('message-modal').classList.replace('modal-active', 'modal-inactive');

                document.getElementById('search-input').addEventListener('input', renderGallery);
                document.getElementById('favorites-toggle').addEventListener('change', renderGallery);
                
                // ================= CORREGIDO: Listener de los filtros de categoría =================
                document.getElementById('category-filters').addEventListener('click', e => {
                    if (e.target.classList.contains('category-btn')) {
                        document.querySelectorAll('.category-btn').forEach(btn => {
                            btn.classList.remove('bg-emerald-500', 'text-white');
                            btn.classList.add('bg-slate-200', 'text-slate-600', 'hover:bg-slate-300');
                        });
                        e.target.classList.add('bg-emerald-500', 'text-white');
                        e.target.classList.remove('bg-slate-200', 'text-slate-600', 'hover:bg-slate-300');
                        renderGallery(); // Vuelve a renderizar la galería con el filtro aplicado
                    }
                });
                // ===============================================================================

                document.getElementById('stickers-container').addEventListener('click', e => {
                    const favButton = e.target.closest('.favorite-btn');
                    if (favButton) {
                        favorites[favButton.dataset.url] = !favorites[favButton.dataset.url];
                        saveState();
                        renderGallery();
                    }
                });

                document.getElementById('add-page-btn').addEventListener('click', () => {
                    syncAndSave(); pages.push({ id: crypto.randomUUID(), canvas: null, objects: [] }); currentPageIndex = pages.length - 1; renderCurrentPage();
                });
                document.getElementById('prev-page-btn').addEventListener('click', () => {
                    if (currentPageIndex > 0) { syncAndSave(); currentPageIndex--; renderCurrentPage(); }
                });
                document.getElementById('next-page-btn').addEventListener('click', () => {
                    if (currentPageIndex < pages.length - 1) { syncAndSave(); currentPageIndex++; renderCurrentPage(); }
                });

                document.getElementById('toggle-gallery-btn').addEventListener('click', () => document.getElementById('gallery-panel').classList.toggle('-translate-x-full'));
                document.getElementById('close-gallery-btn').addEventListener('click', () => document.getElementById('gallery-panel').classList.add('-translate-x-full'));
                
                document.getElementById('exportPdfBtn').addEventListener('click', async () => {
                    syncAndSave();
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });
                    showModal("Exportando tu diseño... Por favor, espera.");

                    try {
                        for (let i = 0; i < pages.length; i++) {
                            const pageData = pages[i];
                            const tempCanvas = new fabric.StaticCanvas(null, {
                                width: EXPORT_WIDTH_PX, height: EXPORT_HEIGHT_PX, backgroundColor: '#FFFFFF'
                            });

                            if (pageData.objects && pageData.objects.length > 0) {
                                const objects = await new Promise(resolve => fabric.util.enlivenObjects(pageData.objects, resolve, ''));
                                
                                const scaleFactor = EXPORT_WIDTH_PX / canvas.getWidth();

                                objects.forEach(obj => {
                                    const newProps = {
                                        left: obj.left * scaleFactor, top: obj.top * scaleFactor,
                                        scaleX: obj.scaleX * scaleFactor, scaleY: obj.scaleY * scaleFactor
                                    };
                                    if (obj.type.includes('text')) {
                                        newProps.fontSize = (obj.fontSize || 0) * scaleFactor;
                                    }
                                    obj.set(newProps);
                                    tempCanvas.add(obj);
                                });
                            }
                            
                            tempCanvas.renderAll();
                            const imgData = tempCanvas.toDataURL({ format: 'jpeg', quality: 0.9 });
                            
                            if (i > 0) pdf.addPage();
                            pdf.addImage(imgData, "JPEG", 0, 0, A4_WIDTH_MM, A4_HEIGHT_MM);
                        }
                        
                        pdf.save("diseno_stickeame.pdf");
                        hideModal();
                        showModal('¡Tu diseño se ha descargado!', `<a href="https://wa.me/543755298440?text=${encodeURIComponent('¡Hola! Te envío mi diseño.')}" target="_blank" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 block"><i class="fa-brands fa-whatsapp mr-2"></i>Enviar</a><button onclick="hideModal()" class="mt-2 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cerrar</button>`);
                    
                    } catch (err) {
                        console.error("Error al exportar:", err);
                        showModal("Hubo un error al exportar el PDF. Intenta de nuevo.");
                    }
                });
                
                document.getElementById('reset-app-btn').addEventListener('click', () => {
                    if(confirm('¿Seguro? Se borrará todo.')) {
                        localStorage.removeItem('stickeameState'); window.location.reload();
                    }
                });
                
                document.getElementById('addTextBtn').addEventListener('click', () => {
                    const text = new fabric.IText('Toca para editar', {
                        left: canvas.getWidth() / 2, top: canvas.getHeight() / 2, originX: 'center', originY: 'center',
                        fontSize: 50, fontFamily: 'Inter', fill: '#000'
                    });
                    canvas.add(text).setActiveObject(text);
                });

                document.getElementById('upload-images').addEventListener('change', (e) => {
                    Array.from(e.target.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (event) => addImageToCanvas(event.target.result);
                        reader.readAsDataURL(file);
                    });
                    e.target.value = '';
                });

                document.getElementById('deleteSelectionBtn').addEventListener('click', () => {
                    canvas.getActiveObjects().forEach(obj => canvas.remove(obj));
                    canvas.discardActiveObject().renderAll();
                });
                
                canvas.on({ 'object:added': syncAndSave, 'object:removed': syncAndSave, 'object:modified': syncAndSave, 'selection:created': e => togglePanels(e.target), 'selection:updated': e => togglePanels(e.target), 'selection:cleared': () => togglePanels(null) });
                
                const textPanel = document.getElementById('text-panel');
                const layerPanel = document.getElementById('layer-panel');
                document.getElementById('close-panel').addEventListener('click', () => textPanel.classList.add('hidden'));
                document.getElementById('close-layer-panel').addEventListener('click', () => layerPanel.classList.add('hidden'));

                document.getElementById('fontBtn').addEventListener('click', () => document.getElementById('font-options').classList.toggle('hidden'));
                document.getElementById('colorBtn').addEventListener('click', () => document.getElementById('color-options').classList.toggle('hidden'));

                const setTextProperty = (prop, value) => {
                    const activeObject = canvas.getActiveObject();
                    if (activeObject && (activeObject.type === 'i-text' || activeObject.type === 'textbox')) {
                        activeObject.set(prop, value);
                        canvas.renderAll();
                        syncAndSave();
                    }
                };

                document.getElementById('boldBtn').addEventListener('click', () => setTextProperty('fontWeight', canvas.getActiveObject()?.fontWeight === 'bold' ? 'normal' : 'bold'));
                document.getElementById('italicBtn').addEventListener('click', () => setTextProperty('fontStyle', canvas.getActiveObject()?.fontStyle === 'italic' ? 'normal' : 'italic'));
                document.getElementById('underlineBtn').addEventListener('click', () => setTextProperty('underline', !canvas.getActiveObject()?.underline));

                document.querySelectorAll('.font-option').forEach(btn => btn.addEventListener('click', () => {setTextProperty('fontFamily', btn.dataset.font); btn.parentElement.classList.add('hidden');}));
                document.querySelectorAll('.color-swatch').forEach(swatch => swatch.addEventListener('click', () => {setTextProperty('fill', swatch.dataset.color); swatch.parentElement.classList.add('hidden');}));
                
                window.addEventListener('resize', resizeCanvas);
            }
            
            function togglePanels(obj) {
                const textPanel = document.getElementById('text-panel');
                const layerPanel = document.getElementById('layer-panel');
                textPanel.classList.add('hidden'); layerPanel.classList.add('hidden');
                if (obj) {
                    if (obj.type === 'i-text' || obj.type === 'textbox') textPanel.classList.remove('hidden');
                    else if (obj.type === 'image') layerPanel.classList.remove('hidden');
                }
            }
            
            init();
        });
    </script>
</body>
</html>
