<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Hojas Carta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" xintegrity="sha512-z3gLPD7yG52hLdFj9yP4vI7zC3pW6hS5F5E5M5Q5S5C5S5L5N5T5R5E5I5G5A5P5C5Q5U5Y5D5R5C5R5S5N5G5I5T5A5K5J5K5L5M5N5O5P5Q5R5S5T5U5V5W5X5Y5Z5a5b5c5d5e5f5g5h5i5j5k5l5m5n5o5p5q5r5s5t5u5v5w5x5y5z5A5B5C5D5E5F5G5H5I5J5K5L5M5N5O5P5Q5R5S5T5U5V5W5X5Y5Z5p6" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal {
            transition: all 0.3s ease-in-out;
        }
        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-inactive {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <!-- Modal para mensajes -->
    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 modal-inactive">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-buttons" class="flex flex-col gap-2">
                <button onclick="hideModal()" class="bg-green-700 text-white px-4 py-2 rounded-md hover:bg-green-800 transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Encabezado -->
    <header class="flex items-center justify-between bg-green-900 text-white px-4 py-2 shadow-md rounded-b-md">
        <div class="flex items-center space-x-3">
            <!-- Logo de la empresa -->
            <img src="https://i.postimg.cc/Qx78s9p9/image-13d0ba-recortada.jpg" alt="PEDRiiXD ALVEZ Logo" class="h-10 w-auto rounded-full">
            <span class="font-bold text-xl select-none">PEDRiiXD ALVEZ</span>
        </div>
        <nav class="flex items-center space-x-3">
            <a href="https://www.instagram.com/pedriixd.alvez" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="p-2 rounded hover:bg-green-700 transition">
                <i class="fa-brands fa-instagram"></i>
            </a>
            <a href="https://wa.me/543755298440" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp" class="p-2 rounded hover:bg-green-700 transition">
                <i class="fa-brands fa-whatsapp"></i>
            </a>
            <button id="newPageBtn" class="flex items-center gap-1 bg-green-700 hover:bg-green-800 px-3 py-1 rounded transition" type="button">
                <i class="fa-solid fa-file-circle-plus"></i>
                Nueva hoja Carta
            </button>
            <button id="saveProjectBtn" class="p-2 rounded hover:bg-green-700 transition" type="button" title="Guardar proyecto en un archivo">
                <i class="fa-solid fa-save"></i>
            </button>
            <label for="loadProjectInput" class="p-2 rounded hover:bg-green-700 transition cursor-pointer" title="Cargar proyecto desde un archivo">
                <i class="fa-solid fa-upload"></i>
            </label>
            <input type="file" id="loadProjectInput" class="hidden" accept=".json">
        </nav>
    </header>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden p-2 md:p-4">
        <!-- Editor principal y barra de herramientas -->
        <div class="flex-1 flex flex-col items-center p-2 md:p-4 bg-gray-200 rounded-lg shadow-inner">
            <div class="flex flex-wrap items-center justify-center gap-2 bg-green-800 p-2 rounded-t-md shadow-inner text-white w-full">
                <label for="upload-images" class="flex items-center gap-1 cursor-pointer bg-green-700 hover:bg-green-900 px-3 py-1 rounded transition select-none">
                    <i class="fa-solid fa-image"></i>
                    Subir im치genes
                    <input id="upload-images" type="file" accept="image/jpeg,image/png,image/webp" multiple class="hidden">
                </label>
                <button id="clearPageBtn" class="flex items-center gap-1 bg-green-700 hover:bg-green-900 px-3 py-1 rounded transition" type="button">
                    <i class="fa-solid fa-trash-can"></i>
                    Limpiar p치gina
                </button>
                <button id="addPageBtn" class="flex items-center gap-1 bg-green-700 hover:bg-green-900 px-3 py-1 rounded transition" type="button">
                    <i class="fa-solid fa-file-circle-plus"></i>
                    Agregar p치gina
                </button>
                <button id="deleteSelectionBtn" class="flex items-center gap-1 bg-green-700 hover:bg-green-900 px-3 py-1 rounded transition" type="button">
                    <i class="fa-solid fa-times"></i>
                    Eliminar selecci칩n
                </button>
                <button id="addTextBtn" class="flex items-center gap-1 bg-green-700 hover:bg-green-900 px-3 py-1 rounded transition" type="button">
                    <i class="fa-solid fa-font"></i>
                    A침adir Texto
                </button>
                <button id="exportPdfBtn" class="flex items-center gap-1 bg-green-700 hover:bg-green-900 px-3 py-1 rounded transition" type="button">
                    <i class="fa-solid fa-file-pdf"></i>
                    Exportar PDF
                </button>
            </div>
            
            <div id="canvas-container" class="flex-1 flex items-center justify-center overflow-auto p-4 w-full">
                <canvas id="canvas" class="page-shadow border-4 border-cyan-400"></canvas>
            </div>

            <div class="flex items-center justify-center gap-3 p-2 bg-green-900 text-white rounded-b-md shadow-inner w-full">
                <button id="prevPageBtn" class="p-2 rounded hover:bg-green-700 transition" type="button">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <span id="pageInfo" class="select-none"></span>
                <button id="nextPageBtn" class="p-2 rounded hover:bg-green-700 transition" type="button">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <button id="duplicatePageBtn" class="p-2 rounded hover:bg-green-700 transition" type="button">
                    <i class="fa-solid fa-copy"></i>
                </button>
                <button id="deletePageBtn" class="p-2 rounded hover:bg-green-700 transition" type="button">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Funciones del modal
        function showModal(message, showWhatsappButton = false) {
            const modal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // Limpiar botones anteriores

            // Bot칩n de cerrar
            const closeBtn = document.createElement('button');
            closeBtn.onclick = hideModal;
            closeBtn.className = "bg-green-700 text-white px-4 py-2 rounded-md hover:bg-green-800 transition";
            closeBtn.textContent = "Cerrar";
            modalButtons.appendChild(closeBtn);

            // Bot칩n de WhatsApp
            if (showWhatsappButton) {
                const waBtn = document.createElement('a');
                const encodedMessage = encodeURIComponent("hola游땕, queria solicitarte esta plancha");
                waBtn.href = `https://wa.me/543755298440?text=${encodedMessage}`;
                waBtn.target = "_blank";
                waBtn.className = "bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition flex items-center justify-center gap-2";
                waBtn.innerHTML = '<i class="fa-brands fa-whatsapp"></i> Enviar por WhatsApp';
                modalButtons.insertBefore(waBtn, modalButtons.firstChild);
            }
            
            modal.classList.add('modal-active');
            modal.classList.remove('modal-inactive');
        }

        function hideModal() {
            const modal = document.getElementById('message-modal');
            modal.classList.remove('modal-active');
            modal.classList.add('modal-inactive');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const LETTER_ASPECT_RATIO = 215.9 / 279.4;
            const DPI = 96; // Standard DPI for web
            const MM_IN_INCH = 25.4;
            
            let canvas, pages = [], currentPageIndex = 0;
            const canvasContainer = document.getElementById('canvas-container');
            const pageInfoSpan = document.getElementById('pageInfo');
            const addTextBtn = document.getElementById('addTextBtn');
            const loadProjectInput = document.getElementById('loadProjectInput');

            // Inicializar Fabric.js
            canvas = new fabric.Canvas('canvas');
            let dimensionText = null;

            // Establecer el fondo del canvas en blanco
            canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));

            // Ajustar el tama침o del canvas al contenedor
            function resizeCanvas() {
                const containerWidth = canvasContainer.clientWidth;
                const containerHeight = canvasContainer.clientHeight;
                let newWidth, newHeight;
                if (containerWidth / containerHeight > LETTER_ASPECT_RATIO) {
                    newHeight = containerHeight - 16;
                    newWidth = newHeight * LETTER_ASPECT_RATIO;
                } else {
                    newWidth = containerWidth - 16;
                    newHeight = newWidth / LETTER_ASPECT_RATIO;
                }
                const zoom = newWidth / (215.9 * DPI / MM_IN_INCH); // Calculate zoom based on physical size and DPI
                canvas.setDimensions({ width: newWidth, height: newHeight });
                canvas.setZoom(zoom);
                canvas.renderAll();
            }

            // Renderizar la p치gina actual en el lienzo
            function renderCurrentPage() {
                if (pages.length === 0) {
                    pages.push({ id: crypto.randomUUID(), objects: [] });
                    currentPageIndex = 0;
                }
                canvas.clear();
                const page = pages[currentPageIndex];
                if (page.objects && page.objects.length > 0) {
                    fabric.util.enlivenObjects(page.objects, (objs) => {
                        canvas.add(...objs);
                        canvas.renderAll();
                    });
                }
                updatePageInfo();
                resizeCanvas(); 
            }

            // Actualizar la informaci칩n de la paginaci칩n
            function updatePageInfo() {
                pageInfoSpan.textContent = `P치gina ${currentPageIndex + 1} de ${pages.length}`;
                document.getElementById('prevPageBtn').disabled = currentPageIndex === 0;
                document.getElementById('nextPageBtn').disabled = currentPageIndex === pages.length - 1;
                document.getElementById('deletePageBtn').disabled = pages.length <= 1;
            }

            // Manejar la adici칩n de im치genes, ahora escalando el tama침o y poni칠ndolas encima
            function addImageToCanvas(url) {
                fabric.Image.fromURL(url, (img) => {
                    const canvasCenter = canvas.getCenter();
                    
                    // Escalar la imagen si es demasiado grande
                    const maxImgWidth = canvas.getWidth() * 0.7;
                    const maxImgHeight = canvas.getHeight() * 0.7;

                    if (img.width > maxImgWidth || img.height > maxImgHeight) {
                        if (img.width / maxImgWidth > img.height / maxImgHeight) {
                            img.scaleToWidth(maxImgWidth);
                        } else {
                            img.scaleToHeight(maxImgHeight);
                        }
                    }

                    img.set({
                        left: canvasCenter.left,
                        top: canvasCenter.top,
                        originX: 'center',
                        originY: 'center',
                    });
                    canvas.add(img);
                    canvas.bringToFront(img);
                    canvas.renderAll();

                    // Forzar la actualizaci칩n del estado para guardar el orden de las capas
                    pages[currentPageIndex].objects = canvas.toJSON().objects;
                });
            }

            // Event Listeners
            document.getElementById('newPageBtn').addEventListener('click', () => {
                pages.push({ id: crypto.randomUUID(), objects: [] });
                currentPageIndex = pages.length - 1;
                renderCurrentPage();
            });

            document.getElementById('addPageBtn').addEventListener('click', () => {
                pages.push({ id: crypto.randomUUID(), objects: [] });
                currentPageIndex = pages.length - 1;
                renderCurrentPage();
            });

            document.getElementById('duplicatePageBtn').addEventListener('click', () => {
                const currentPage = pages[currentPageIndex];
                if (currentPage) {
                    const newPage = { id: crypto.randomUUID(), objects: JSON.parse(JSON.stringify(currentPage.objects)) };
                    pages.splice(currentPageIndex + 1, 0, newPage);
                    currentPageIndex++;
                    renderCurrentPage();
                }
            });

            document.getElementById('deletePageBtn').addEventListener('click', () => {
                if (pages.length <= 1) {
                    showModal("No puedes eliminar la 칰nica p치gina.");
                    return;
                }
                pages.splice(currentPageIndex, 1);
                currentPageIndex = Math.min(currentPageIndex, pages.length - 1);
                renderCurrentPage();
            });

            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPageIndex > 0) {
                    currentPageIndex--;
                    renderCurrentPage();
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPageIndex < pages.length - 1) {
                    currentPageIndex++;
                    renderCurrentPage();
                }
            });

            document.getElementById('upload-images').addEventListener('change', (e) => {
                const files = e.target.files;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const url = event.target.result;
                        addImageToCanvas(url);
                    };
                    reader.readAsDataURL(file);
                });
            });

            document.getElementById('clearPageBtn').addEventListener('click', () => {
                canvas.clear();
                pages[currentPageIndex].objects = [];
                canvas.renderAll();
            });

            document.getElementById('deleteSelectionBtn').addEventListener('click', () => {
                canvas.remove(...canvas.getActiveObjects());
                canvas.renderAll();
            });
            
            addTextBtn.addEventListener('click', () => {
                const text = new fabric.IText('Haz clic para editar', {
                    left: canvas.getWidth() / 2,
                    top: canvas.getHeight() / 2,
                    originX: 'center',
                    originY: 'center',
                    fontSize: 24,
                    fontFamily: 'Inter',
                    fill: '#000',
                });
                canvas.add(text);
                canvas.setActiveObject(text);
                canvas.renderAll();
            });

            document.getElementById('exportPdfBtn').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: "mm", format: "letter" });

                async function exportPage(index) {
                    if (index >= pages.length) {
                        pdf.save("diseno.pdf");
                        showModal("El archivo PDF se ha descargado. Ahora puedes enviarlo por WhatsApp.", true);
                        return;
                    }

                    const pageData = pages[index];
                    const tempCanvas = document.createElement('canvas');
                    const tempFabricCanvas = new fabric.Canvas(tempCanvas, {
                        width: 215.9 * DPI / MM_IN_INCH,
                        height: 279.4 * DPI / MM_IN_INCH
                    });

                    // Establecer el fondo en blanco antes de renderizar y exportar
                    tempFabricCanvas.setBackgroundColor('#FFFFFF', async () => {
                        await new Promise(resolve => {
                            fabric.util.enlivenObjects(pageData.objects, (enlived) => {
                                enlived.forEach(o => tempFabricCanvas.add(o));
                                resolve();
                            });
                        });
    
                        const imgData = tempFabricCanvas.toDataURL({ format: 'jpeg', quality: 1.0 });
                        if (index > 0) pdf.addPage();
                        pdf.addImage(imgData, "JPEG", 0, 0, 215.9, 279.4);
    
                        exportPage(index + 1);
                    });
                }
                
                showModal("Exportando a PDF... Por favor, espera.", false);
                exportPage(0);
            });

            document.getElementById('saveProjectBtn').addEventListener('click', () => {
                const project = { pages };
                const blob = new Blob([JSON.stringify(project)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `proyecto-diseno-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showModal("Proyecto guardado como un archivo JSON. 춰Ya puedes descargarlo!");
            });

            loadProjectInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const project = JSON.parse(event.target.result);
                        pages = project.pages || [{ id: "page1", objects: [] }];
                        currentPageIndex = 0;
                        
                        renderCurrentPage();
                        showModal("Proyecto cargado con 칠xito. Por favor, vuelve a subir las im치genes.");
                    } catch (error) {
                        console.error("Error al cargar el proyecto:", error);
                        showModal("Error al cargar el archivo. Aseg칰rate de que es un archivo de proyecto v치lido.");
                    }
                };
                reader.readAsText(file);
            });

            // Sincronizar cambios del lienzo con el estado
            canvas.on('object:modified', () => {
                pages[currentPageIndex].objects = canvas.toJSON().objects;
            });
            canvas.on('object:added', () => {
                pages[currentPageIndex].objects = canvas.toJSON().objects;
            });
            canvas.on('object:removed', () => {
                pages[currentPageIndex].objects = canvas.toJSON().objects;
            });
            
            // Funci칩n para mostrar las medidas de un objeto
            function showDimensionText(obj) {
                // Remove existing text if any
                if (dimensionText) {
                    canvas.remove(dimensionText);
                }

                if (obj.type === 'image') {
                    const zoom = canvas.getZoom();
                    const widthCm = (obj.getScaledWidth() / (DPI / MM_IN_INCH) / zoom).toFixed(1);
                    const heightCm = (obj.getScaledHeight() / (DPI / MM_IN_INCH) / zoom).toFixed(1);
                    const dimensions = `${widthCm} x ${heightCm} cm`;
                    
                    dimensionText = new fabric.Text(dimensions, {
                        fontSize: 14,
                        fill: '#FFFFFF',
                        backgroundColor: '#333333',
                        padding: 5,
                        selectable: false,
                        evented: false,
                    });
                    
                    canvas.add(dimensionText);
                    updateDimensionTextPosition(obj);
                }
            }
            
            // Funci칩n para actualizar la posici칩n del texto de medidas
            function updateDimensionTextPosition(obj) {
                if (dimensionText) {
                    const objCenter = obj.getCenterPoint();
                    dimensionText.set({
                        left: objCenter.x,
                        top: obj.top - dimensionText.height / 2 - 10,
                        originX: 'center',
                    });
                    canvas.renderAll();
                }
            }

            // Ocultar las medidas
            function hideDimensionText() {
                if (dimensionText) {
                    canvas.remove(dimensionText);
                    dimensionText = null;
                    canvas.renderAll();
                }
            }

            // Eventos para mostrar y ocultar las medidas
            canvas.on('object:scaling', (e) => showDimensionText(e.target));
            canvas.on('object:moving', (e) => showDimensionText(e.target));
            canvas.on('mouse:down', (e) => {
                if (!e.target || e.target.type !== 'image') {
                    hideDimensionText();
                }
            });
            canvas.on('object:modified', hideDimensionText);
            canvas.on('selection:cleared', hideDimensionText);
            canvas.on('object:removed', hideDimensionText);
            
            // Inicializaci칩n de la aplicaci칩n
            pages = [{ id: crypto.randomUUID(), objects: [] }];
            resizeCanvas();
            renderCurrentPage();

            window.addEventListener('resize', resizeCanvas);
        });
    </script>
</body>
</html>
