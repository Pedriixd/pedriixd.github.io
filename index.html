<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STICKEAME - Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Comic+Neue:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-inactive { opacity: 0; pointer-events: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        /* Estilo para el contenedor del logo y el texto de fallback */
        #logo-container {
            display: flex;
            align-items: center;
            height: 40px; /* Misma altura que el logo */
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-900 flex flex-col h-screen">

    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 modal-inactive">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-buttons" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <header class="flex items-center justify-between bg-emerald-300 text-gray-900 px-4 py-2 shadow-md rounded-b-md z-20">
        <div class="flex items-center space-x-3">
            <button id="toggle-gallery-btn" class="md:hidden flex items-center gap-2 bg-white text-emerald-700 font-semibold px-3 py-1 rounded-md shadow hover:bg-gray-200 transition">
                <i class="fa-solid fa-images"></i>
                <span>Galería</span>
            </button>
            <div id="logo-container">
                <img src="logo.png" alt="STICKEAME Logo" class="h-10 w-auto rounded-full" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='inline';">
                <span id="logo-fallback" class="font-bold text-xl select-none" style="display:none;">STICKEAME</span>
            </div>
            <span class="font-bold text-xl select-none hidden sm:inline">STICKEAME</span>
        </div>
        <nav class="flex items-center space-x-3">
            <a href="https://www.instagram.com/pedriixd.alvez" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="p-4 rounded-lg bg-gradient-to-tr from-yellow-300 via-pink-500 to-purple-600 text-white shadow-lg hover:scale-110 transition-transform duration-300 text-2xl">
                <i class="fa-brands fa-instagram"></i>
            </a>
        </nav>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside id="gallery-panel" class="w-full md:w-72 lg:w-96 bg-white shadow-lg p-4 flex-col gap-4 absolute md:relative z-10 md:z-0 h-full md:flex -translate-x-full md:translate-x-0 transition-transform duration-300">
             <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold">Galería de Stickers</h2>
                <button id="close-gallery-btn" class="md:hidden p-2 rounded-full hover:bg-gray-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex flex-col gap-3 mb-3">
                <input id="search-input" type="text" placeholder="Buscar por nombre..." class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400">
                <div id="category-filters" class="flex flex-wrap gap-2"></div>
                <label class="flex items-center gap-2 cursor-pointer"><input id="favorites-toggle" type="checkbox" class="h-5 w-5 text-emerald-500 rounded"/> <span>Mostrar solo favoritos</span></label>
            </div>
            <div id="stickers-container" class="flex-1 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-3 pr-2 scrollbar-hide">
            </div>
        </aside>

        <main class="flex-1 flex flex-col p-2 md:p-4 bg-slate-50">
            <div class="flex-1 flex items-stretch bg-white rounded-lg shadow-inner overflow-hidden relative">
                <div id="canvas-container" class="flex-1 flex items-center justify-center p-2">
                    <canvas id="canvas" class="shadow-2xl"></canvas>
                </div>

                <div id="text-panel" class="hidden absolute right-0 top-0 h-full flex-shrink-0 w-64 p-4 border-l bg-gray-50/90 backdrop-blur-sm rounded-r-lg shadow-lg overflow-y-auto">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Editar Texto</h2>
                        <button id="close-panel" class="p-1 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="fontBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100 w-full"><i class="fa-solid fa-font mr-2"></i>Fuentes</button>
                        <div id="font-options" class="hidden flex flex-col space-y-1 p-2 bg-gray-100 rounded-md">
                            <button class="font-option text-left p-1 rounded hover:bg-gray-200" data-font="Inter">Inter</button>
                            <button class="font-option text-left p-1 rounded hover:bg-gray-200" data-font="Arial">Arial</button>
                             <button class="font-option text-left p-1 rounded hover:bg-gray-200" data-font="Times New Roman">Times New Roman</button>
                            <button class="font-option text-left p-1 rounded hover:bg-gray-200" data-font="Comic Neue">Comic Neue</button>
                        </div>
                        <button id="colorBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100 w-full"><i class="fa-solid fa-palette mr-2"></i>Colores</button>
                        <div id="color-options" class="hidden grid grid-cols-5 gap-2 p-2 bg-gray-100 rounded-md">
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm border" style="background-color: #000000;" data-color="#000000"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm border" style="background-color: #FFFFFF;" data-color="#FFFFFF"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm" style="background-color: #FF0000;" data-color="#FF0000"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm" style="background-color: #008000;" data-color="#008000"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm" style="background-color: #0000FF;" data-color="#0000FF"></div>
                            <div class="color-swatch w-6 h-6 rounded-full cursor-pointer shadow-sm" style="background-color: #FFFF00;" data-color="#FFFF00"></div>
                        </div>
                        <button id="boldBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100 w-full"><i class="fa-solid fa-bold mr-2"></i>Negrita</button>
                        <button id="italicBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100 w-full"><i class="fa-solid fa-italic mr-2"></i>Cursiva</button>
                        <button id="underlineBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100 w-full"><i class="fa-solid fa-underline mr-2"></i>Subrayado</button>
                    </div>
                </div>

                <div id="layer-panel" class="hidden absolute right-0 top-0 h-full flex-shrink-0 w-64 p-4 border-l bg-gray-50/90 backdrop-blur-sm rounded-r-lg shadow-lg">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Capas</h2>
                        <button id="close-layer-panel" class="p-1 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="bringForwardBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100"><i class="fa-solid fa-arrow-up mr-2"></i>Adelante</button>
                        <button id="sendBackwardBtn" class="bg-white text-left font-semibold py-2 px-4 rounded-md shadow-sm border hover:bg-gray-100"><i class="fa-solid fa-arrow-down mr-2"></i>Atrás</button>
                    </div>
                </div>
            </div>

            <footer class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 bg-emerald-300 p-2 md:p-3 rounded-t-md shadow-inner text-gray-900 mt-2">
                <button id="exportPdfBtn" class="flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-600 px-3 py-2 rounded transition shadow-xl font-semibold text-white"><i class="fa-solid fa-file-pdf"></i><span>Descargar PDF</span></button>
                <label for="upload-images" class="flex items-center justify-center gap-2 cursor-pointer bg-emerald-500 hover:bg-emerald-600 px-3 py-2 rounded transition select-none shadow-xl font-semibold text-white"><i class="fa-solid fa-image"></i><span>Subir Imagen</span><input id="upload-images" type="file" accept="image/jpeg,image/png,image/webp" multiple class="hidden"></label>
                <button id="addTextBtn" class="flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-600 px-3 py-2 rounded transition shadow-xl font-semibold text-white"><i class="fa-solid fa-font"></i><span>Añadir Texto</span></button>
                <button id="deleteSelectionBtn" class="flex items-center justify-center gap-2 bg-rose-500 hover:bg-rose-600 px-3 py-2 rounded transition shadow-xl font-semibold text-white"><i class="fa-solid fa-times"></i><span>Eliminar</span></button>
                <div class="col-span-2 lg:col-span-1 flex items-center justify-center gap-2 bg-white/50 p-2 rounded-md">
                    <button id="prev-page-btn" class="px-2 py-1 rounded hover:bg-emerald-200"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="page-indicator" class="font-semibold text-sm">Pág 1 / 1</span>
                    <button id="next-page-btn" class="px-2 py-1 rounded hover:bg-emerald-200"><i class="fa-solid fa-chevron-right"></i></button>
                    <button id="add-page-btn" class="px-2 py-1 rounded bg-emerald-500 text-white hover:bg-emerald-600"><i class="fa-solid fa-plus"></i></button>
                </div>
                <button id="reset-app-btn" class="flex items-center justify-center gap-2 bg-amber-500 hover:bg-amber-600 px-3 py-2 rounded transition shadow-xl font-semibold text-white"><i class="fa-solid fa-arrows-rotate"></i><span>Resetear</span></button>
            </footer>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const A4_ASPECT_RATIO = 210 / 297;
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const DPI = 300;
            const EXPORT_WIDTH_PX = Math.round((A4_WIDTH_MM * DPI) / 25.4);
            const EXPORT_HEIGHT_PX = Math.round((A4_HEIGHT_MM * DPI) / 25.4);

            let canvas, pages = [], currentPageIndex = 0, allStickers = [], favorites = {};

            const init = () => {
                canvas = new fabric.Canvas('canvas', { backgroundColor: '#FFFFFF' });
                loadState();
                fetchData();
                addEventListeners();
                renderCurrentPage();
                resizeCanvas();
            };

            const saveState = () => {
                try {
                    const state = {
                        pages: pages.map(p => ({ id: p.id, objects: p.canvas ? p.canvas.toJSON().objects : p.objects })),
                        currentPageIndex,
                        favorites
                    };
                    localStorage.setItem('stickeameState', JSON.stringify(state));
                } catch (error) {
                    console.error("Error al guardar el estado:", error);
                }
            };
            
            const loadState = () => {
                const savedState = localStorage.getItem('stickeameState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    pages = state.pages.map(p => ({ id: p.id, canvas: null, objects: p.objects }));
                    currentPageIndex = state.currentPageIndex || 0;
                    favorites = state.favorites || {};
                }
                if (pages.length === 0) {
                    pages.push({ id: crypto.randomUUID(), canvas: null, objects: [] });
                }
            };

            const fetchData = () => {
                allStickers = [
                  // Tu JSON completo va aquí
                  {"categoria": "rutas", "nombre": "ruta 9.png", "url": "https://drive.google.com/uc?export=view&id=17Ys-uQvMN4mCNHAm_e3rnvGp5GDmZGQb"},
                  {"categoria": "rutas", "nombre": "ruta 12.png", "url": "https://drive.google.com/uc?export=view&id=1mmgpv82b7pxmENmQv6ORlafOCol2fztz"},
                  // ... y así sucesivamente hasta el último sticker
                  {"categoria": "Tv", "nombre": "pegatinas-coches-motos-angry-birds-hitchcock.png", "url": "https://drive.google.com/uc?export=view&id=1coDYGWHjw4x_7O-PdbYI1-0Q1ywhP6P6"}
                ];
                renderGallery();
            };

            const renderGallery = () => {
                // ... (código sin cambios)
            };

            const resizeCanvas = () => {
                const container = document.getElementById('canvas-container');
                const { clientWidth: cw, clientHeight: ch } = container;
                let newWidth, newHeight;
                if ((cw / ch) > A4_ASPECT_RATIO) {
                    newHeight = ch - 20;
                    newWidth = newHeight * A4_ASPECT_RATIO;
                } else {
                    newWidth = cw - 20;
                    newHeight = newWidth / A4_ASPECT_RATIO;
                }
                canvas.setDimensions({ width: newWidth, height: newHeight });
            };
            
            const renderCurrentPage = () => {
                const page = pages[currentPageIndex];
                if (!page.canvas) {
                    page.canvas = new fabric.Canvas(null);
                }
                canvas.clear();
                if (page.objects && page.objects.length > 0) {
                    canvas.loadFromJSON({ objects: page.objects }, () => {
                        canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
                    });
                } else {
                    canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
                }
                pages[currentPageIndex].canvas = canvas;
                document.getElementById('page-indicator').textContent = `Pág ${currentPageIndex + 1} / ${pages.length}`;
            };
            
            const syncAndSave = () => {
                if (pages[currentPageIndex]) {
                    pages[currentPageIndex].objects = canvas.toJSON().objects;
                    saveState();
                }
            };

            const addImageToCanvas = (url) => {
                fabric.Image.fromURL(url, (img) => {
                    img.scaleToWidth(canvas.getWidth() * 0.5);
                    img.set({ left: canvas.getWidth() / 2, top: canvas.getHeight() / 2, originX: 'center', originY: 'center' });
                    canvas.add(img);
                }, { crossOrigin: 'anonymous' });
            };

            function addEventListeners() {
                // ... (código de listeners de modal, galería, paginador, etc. sin cambios)
                
                // ================= MODIFICADO: Nueva función de exportación a PDF =================
                document.getElementById('exportPdfBtn').addEventListener('click', async () => {
                    syncAndSave(); // Guarda el estado de la página actual
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });
                    showModal("Exportando tu diseño... Por favor, espera.");

                    const originalPageIndex = currentPageIndex;
                    
                    try {
                        for (let i = 0; i < pages.length; i++) {
                            // Carga cada página en el canvas principal para renderizarla
                            await new Promise(resolve => {
                                canvas.loadFromJSON({ objects: pages[i].objects }, () => {
                                    canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
                                    // Espera un pequeño instante para asegurar que las imágenes se rendericen
                                    setTimeout(resolve, 100); 
                                });
                            });
                            
                            // Calcula el multiplicador para obtener una imagen de 300 DPI
                            const multiplier = EXPORT_WIDTH_PX / canvas.getWidth();
                            
                            const imgData = canvas.toDataURL({
                                format: 'jpeg',
                                quality: 0.9,
                                multiplier: multiplier,
                                backgroundColor: '#FFFFFF'
                            });

                            if (i > 0) pdf.addPage();
                            
                            // Añade la imagen al PDF, forzando las dimensiones a A4
                            pdf.addImage(imgData, "JPEG", 0, 0, A4_WIDTH_MM, A4_HEIGHT_MM);
                        }

                        // Restaura la vista original del editor a la página en la que estaba el usuario
                        await new Promise(resolve => {
                             canvas.loadFromJSON({ objects: pages[originalPageIndex].objects }, () => {
                                canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
                                resolve();
                            });
                        });
                        
                        pdf.save("diseno_stickeame.pdf");
                        hideModal();
                        showModal('¡Tu diseño se ha descargado!', `<a href="https://wa.me/543755298440?text=${encodeURIComponent('¡Hola! Te envío mi diseño.')}" target="_blank" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600 block"><i class="fa-brands fa-whatsapp mr-2"></i>Enviar por WhatsApp</a><button onclick="hideModal()" class="mt-2 bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-400">Cerrar</button>`);
                    
                    } catch (err) {
                        console.error("Error al exportar:", err);
                        showModal("Hubo un error al exportar el PDF. Intenta de nuevo.");
                         // Asegúrate de restaurar la vista si hay un error
                        await new Promise(resolve => {
                             canvas.loadFromJSON({ objects: pages[originalPageIndex].objects }, () => {
                                canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
                                resolve();
                            });
                        });
                    }
                });
                // =================================================================================

                // (El resto de listeners de botones de acción y paneles de texto siguen aquí)
                // ...
            }
            
            function togglePanels(obj) {
                // ... (código sin cambios)
            }
            
            init();
        });
    </script>
</body>
</html>
